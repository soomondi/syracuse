---
title: "Final Exam - Quantitative Reasoning for Data Science"
author: "STEPHEN O OMONDI"
date: "3/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load datasets

```{r}
load("C:/Academics/IST 722 - Quantitative Reasoning for Data Science/Final Exam/Final exam and data/allSchoolsReportStatus.RData")

load("C:/Academics/IST 722 - Quantitative Reasoning for Data Science/Final Exam/Final exam and data/usVaccines.RData")

# Load the dataset
load("C:/Users/StephenOmondi/Downloads/reportSample10.RData")
```


## 1. What proportion of public schools reported vaccination data?

First, here is the total number of all Kindergarten Public schools in California:

```{r}

#head(allSchoolsReportStatus)

# fetch all the public schools

publicSchools <- allSchoolsReportStatus[allSchoolsReportStatus$pubpriv == "PUBLIC",]
(countPublicSchools <- nrow(publicSchools))

```

There are a total of 5732 Kindergarten Public Schools in California.

Below, is the separation of the 5732 Public Schools into those that reported vaccination and those that did not.

```{r}
PublicSchoolsThatReported <- publicSchools[publicSchools$reported == "Y",]
(countPublicSchoolsThatReported <- nrow(PublicSchoolsThatReported))


PublicSchoolsThatDidNotReport <-  publicSchools[publicSchools$reported == "N",]
(countPublicSchoolsThatDidNotReport <- nrow(PublicSchoolsThatDidNotReport))

#mean(countPublicSchoolsThatDidNotReport)
```

Out of the 5732 Public Schools, 5584 reported vaccinations, while 148 did not.

Below is the Calculation of this breakdown into proportions

```{r}

(round((countPublicSchoolsThatReported/countPublicSchools) * 100,0))


(round((countPublicSchoolsThatDidNotReport/countPublicSchools) * 100,0))


```

**In summary, there are 5732 Public Schools, 97% of which reported vaccinations, while 3% did not**

```{r}
library(RColorBrewer)
myPalette <- brewer.pal(5, "Set2") 

pie(c(countPublicSchoolsThatReported,countPublicSchoolsThatDidNotReport), labels = c("Reported (97%)","Did Not Report - 3%"), radius = 1, col = myPalette, border = "white", main = "Public Schools Vaccine Reporting Proportions")
```


## 2. What proportion of private schools reported vaccination data?

First, here is the total number of all Kindergarten Private schools in California:

```{r}

# fetch all the private schools

privateSchools <- allSchoolsReportStatus[allSchoolsReportStatus$pubpriv == "PRIVATE",]
(countPrivateSchools <- nrow(privateSchools))

```

There are a total of 1649 Kindergarten Private Schoolsin California.

Below, is the separation of the 1649 Private Schools into those that reported vaccination and those that did not.

```{r}
privateSchoolsThatReported <- privateSchools[privateSchools$reported == "Y",]
(countPrivateSchoolsThatReported <- nrow(privateSchoolsThatReported))


privateSchoolsThatDidNotReport <-  privateSchools[privateSchools$reported == "N",]
(countPrivateSchoolsThatDidNotReport <- nrow(privateSchoolsThatDidNotReport))


```

Out of the 1649 Private Schools, 1397 reported vaccinations, while 252 did not.

Below is the Calculation of this breakdown into proportions:

```{r}

(round((countPrivateSchoolsThatReported/countPrivateSchools) * 100,0))


(round((countPrivateSchoolsThatDidNotReport/countPrivateSchools) * 100,0))


```

**In summary, there are 1649 Public Schools, 85% of which reported vaccinations, while 15% did not**

```{r}
#library(RColorBrewer)
#myPalette <- brewer.pal(5, "Set2") 

pie(c(countPrivateSchoolsThatReported,countPrivateSchoolsThatDidNotReport), labels = c("Reported (85%)","Did Not Report - 15%"), radius = 1, col = myPalette, border = "white", main = "Private Schools Vaccine Reporting Proportions")
```






## 3. Have U.S. vaccinations rates been stable over time?

First, an investigation of the vaccine data. Is it in time-series form? If not, we apply needed transformations.

```{r}
str(usVaccines)

```

The data is in Time-Series form, no transformation is required. 

**Cleaning the data**

There are several NAs in the dataset. For example:


```{r}
library(imputeTS)
statsNA(usVaccines[,"DTP1"])
```


Below, I remove NAs by interpolation

```{r}
usVaccines <-  na_interpolation(usVaccines, option = "linear")

```

Confirm that all NA's have been removed:

```{r}
str(usVaccines)
```



**Time series plots**

```{r}
plot((usVaccines))
```

Lets decompose the vaccine data into its constituent parts, to investigate trend and seasonality to better describe the data.

**Decompose vaccine data**
```{r}

# convert the period into meaningful time i.e. every 12 calendar months
freq <- 12

decVac <- decompose(ts(usVaccines, frequency=freq))
```


### Analyzing Trend in vaccines ###

```{r}

plot(decVac$trend)

```

The decomposed trend plots shows the X-axis (Time) scaled from 1 to 4 for the full 40 years examined.


**Polio third dose (Pol3):** There was an upward trend in U.S Polio third dose vaccines administered for the period covered. This upward trend appear to have been nearing its plateau.

**Hepatitis B, Birth Dose (HepB_BD):** There was a strong upward trend in Hepatitis B, Birth Dose vaccines from the first recorded time in the year 2000.


**First dose of Diphtheria/Pertussis/Tetanus vaccine (DTP1):** There was a sharp downtrend in DTP1 vaccine for the recorded time.

**Influenza third dose (HiB3):** There was a sharp downtrend in HiB3 vaccines for the recorded period.

**Measles first dose (MCV1):** Overall, the MCV1 vaccines appear to have plateaured.


### Analyzing seasonality of vaccines ###

```{r}
plot(decVac$seasonal)
```

There was some seasonality (0.02369052 ) in US Vaccines, however this was very close to zero as shown in the mean calculation below:

```{r}

mean(decVac$seasonal, na.rm = TRUE)

```

## 4. Are there any notable patterns in U.S. vaccinations rates over time?##

To examine correlations between vaccines, we begin by removing the trend component inherent in the time-series so as to limit the potential for spurious correlations among different vaccines. The plot below shows the vaccines after differencing.

**Differencing to remove trend**

```{r}

diffSet <- diff((usVaccines))

#head(diffSet)

plot(diffSet)

```

The charts show differences in variability at certain times (heteroscdasticity) which point to spikes and dips in vaccinations at those times. For example, there was increased variability between 1985 and approximately 1994 in the administration of the third dose of polio vaccine (Pol3) which is very similar to the spikes and dips observed in the administration of MCV1 vaccines during the same period. These period coincides with the recorded goal set for polio elimination in the Americas that started in 1985 which was closely followed by the Global Polio eradication initiative of 1988 that resulted in the polio being declered elimiated from the Americas in 1994 (https://www.historyofvaccines.org/timeline#EVT_100348).

**Analyzing correlations in US Vaccines**

```{r}
library(corrplot)
corr <- cor(diffSet)
corrplot(corr, method="number")
```

In the correlation plot above, positive correlations are displayed in blue and negative correlations in red color. Color intensity is proportional to the correlation coefficients.

**Finding:** There appears to be a strong correlation between Measles first dose (MCV1) and Polio third dose (Pol3) vaccine rates.


## 5. Was there any credible difference in overall reporting proportions between public and private schools?##

The breadkdown below, shows proportions relative to the total number of schools in the survey.

```{r}

PrivateSchoolBreakdown <- c(countPrivateSchoolsThatReported,countPrivateSchoolsThatDidNotReport)

PublicSchoolBreakdown <- c(countPublicSchoolsThatReported,countPublicSchoolsThatDidNotReport)

# create a matrix of records
AllSchoolsCombined <- matrix(c(PublicSchoolBreakdown,PrivateSchoolBreakdown), ncol = 2, byrow = F)

# set row names
rowtitles <- c("Reported Vaccines","Did Not Report Vaccines")
rownames(AllSchoolsCombined) <- rowtitles

# set colum names
columntitles <- c("Public Schools", "Private Schools")
colnames(AllSchoolsCombined) <- columntitles

# make a table
AllSchoolsCombined <- as.table(AllSchoolsCombined)

# transpose rows to columns
AllSchoolsCombined <- t(AllSchoolsCombined)
AllSchoolsCombined

```


**Total Number of Schools in the survey:**

```{r}
# grand total of schools
(sumAllSchools <- margin.table(AllSchoolsCombined))

```


**Public and Private school totals:**

```{r}

# grand total of rows
(sumRows <- margin.table(AllSchoolsCombined,1))

```


**Vaccination totals:**
```{r}

# grand total of columns
(sumCols <- margin.table(AllSchoolsCombined,2))

```






**Totals expressed as probabilities (of all schools combined):**

```{r}
# probs expressed as percentages
(schoolProbs <- ((AllSchoolsCombined / sumAllSchools)))


```


```{r}
# probs expressed as percentages
(schoolProbs <- round((AllSchoolsCombined / sumAllSchools) * 100)) #express as %
(schoolProbs <- ((AllSchoolsCombined / sumAllSchools) * 100))

```


```{r}
# overall proportions between public kindergartens and all kindergartens
(round((countPublicSchools/sumAllSchools) * 100,0))
# overall proportions between private kindergartens and all kindergartens
(round((countPrivateSchools/sumAllSchools) * 100,0))


# proportions within Private schools
(round((countPrivateSchoolsThatReported/countPrivateSchools) * 100,0))
(round((countPrivateSchoolsThatDidNotReport/countPrivateSchools) * 100,0))


# proportions within Public Schools
(round((countPublicSchoolsThatReported/countPublicSchools) * 100,0))
(round((countPublicSchoolsThatDidNotReport/countPublicSchools) * 100,0))

```

**Findings**:

Overall, there are a total of 7381 Kindergarten schools, in which public schools account for 78% while private schools account for 22%. 

97% of all public schools reported vacciness while 3% did not. However the public school proportion reporting vaccines accounts for 76% of all kindergarten schools, while the proportion that did not report vaccines accounts for 2% of all kindergarten schools.

At the same time, 85% of all private schools reported vaccines while 15% did not. The private school proportion reporting vaccines accounts for 19% of all kindergaten schools, while the proportion that did not report vaccines accoutns for 3% of all kindergarten schools. 



```{r}
pie(c(countPublicSchools ,countPrivateSchools ), labels = c("Public Schools (78%)","Private Schools (22%)"), radius = 1, col = myPalette, border = "white", main = "Proportion of Public and Private schools")


pie(c(countPublicSchoolsThatReported,countPublicSchoolsThatDidNotReport), labels = c("Reported (97%)","Did Not Report - 3%"), radius = 1, col = myPalette, border = "white", main = "Public Schools Vaccine Reporting Proportions")
    

pie(c(countPrivateSchoolsThatReported,countPrivateSchoolsThatDidNotReport), labels = c("Reported (85%)","Did Not Report - 15%"), radius = 1, col = myPalette, border = "white", main = "Private Schools Vaccine Reporting Proportions")
```



## 6. Compare overall vaccination rates (allvaccs) between public and private schools. Are there any credible differences? ##

This report uses the sample report of 698 observations and 13 variables. There are 570 public schools and 128 private schools in the dataset. 100 random vaccine rate sample means are drawn from each group for ease of comparison. The sample means are replicated 1000 times from each group to create a very large sample means because as mean samples (size) increases, the means obvserved are likely to converge to the true population mean and also looks more normal (bell-curved) in shape.


### Data Prep ###

```{r}
#str(reportSample)
str(reportSample$allvaccs)

# are there any missing values in allVaccs?
length(complete.cases(reportSample$allvaccs)) #no missing values


# public schools
PublicSchoolGroup <- reportSample[reportSample$pubpriv=="PUBLIC",]
nrow(PublicSchoolGroup)

# private schools
PrivateSchoolGroup <- reportSample[reportSample$pubpriv=="PRIVATE",]
nrow(PrivateSchoolGroup)

set.seed(123) # control the randomization

# obtain 100 random public school vaccine rates sample means, repeat X1000
vacRates <- replicate(1000, mean(sample(PublicSchoolGroup$allvaccs, 100, replace = TRUE)))
SchoolType <- as.factor("Public")
publicDF <- data.frame(vacRates,SchoolType)


# obtain 100 random private school vaccine rates sample means, repeat X1000
vacRates <- replicate(1000, mean(sample(PrivateSchoolGroup$allvaccs, 100, replace = TRUE)))
SchoolType <- as.factor("Private")
privateDF <- data.frame(vacRates,SchoolType)


# combine both groups into single group of both public and private vaccine rate samples
SchoolVacs <- rbind(publicDF,privateDF)

#View(SchoolVacs)


```


**Box plot of the distributions:**
```{r}
boxplot(vacRates ~ SchoolType, data = SchoolVacs)

```

The box plot shows that the medians of vaccine rates between public school and private schools are very different; public schools have a higher median.

### Frequentist Anova Approach ###

**Analysis of Variance between Public and Private schools Vaccine Rates**
```{r}

vacOut <- aov(vacRates ~ SchoolType, data = SchoolVacs)
summary(vacOut)
```


There were a total of 200 elements, 100 each from public and private schools. The degrees of freedom residual elements are 198 with 1 element left to vary between the two groups during the statistical calculation of ANOVA.

The Sum Sq value is 9332  between groups and 5432 within groups - and it shows the raw initial calculation of variability.

The Mean Sq is 9332 between groups and 3 within groups - and it is the variance (the sum of squares divided by the degress of freedom).

The F-Value of the overall test is 3432 and it is the ratio of the mean squares between and within groups.

The Pr(>F) is the probability of a larger F-value of this ratio (3432) within the F-distribution.

For the result to be statistically significant, the F-Value must substantially exceed 1 under the assumption that all the data was sampled from the same underlying population - as is the case here. Also, the Pr(>F) has to be less than the alpha value ( in this case, alpha is 0.05)

**In summary**:

The **null hypothesis** is that there is no difference in sample means of vaccine rates between public and private schools.

The **alternative hypothesis** is that the sample means of vaccine rates between public and private schools are different.

Since the Pr(>F) of <2e-16 is less than alpha-value (0.05), we reject the null hypothesis and conclude that the test is statistically significant; there is credible evidence that sample means of vaccine rates between public and private schools are different.



### Bayesian Approach Using Bayes Factor Analysis###

A plot of means using the Bayesian Approach: 
```{r}
library(BayesFactor)
vacBayesOut <- anovaBF(vacRates ~ SchoolType, data = SchoolVacs)
mcmcOut <- posterior(vacBayesOut,iterations = 10000)
plot(mcmcOut[,"mu"])
```



**95% HDI distribution of means of all vaccine rates in Private School**

The 95% HDI distribution does not include 0 as shown below which means it deviates from the population mean considerably. The 95% HDI upper bound to lower bounds ranges from -2.2313  to -2.086

```{r}
par(mfcol=c(1,1))
hist(mcmcOut[,"SchoolType-Private"], main = "95% HDI distribution of means of all vaccines in Private School")

# upper and lower bounds of 95% HDI
abline(v=quantile(mcmcOut[,"SchoolType-Private"], c(0.025)), col="blue")
abline(v=quantile(mcmcOut[,"SchoolType-Private"], c(0.975)), col="blue")

```


**95% HDI distribution of means of all vaccine rates in Public School**

The 95% HDI distribution does not include 0 as shown below which means it deviates from the population mean considerably. The 95% HDI upper bound to lower bounds ranges from 2.0860  to 2.231.

```{r}
par(mfcol=c(1,1))
hist(mcmcOut[,"SchoolType-Public"], main = "95% HDI distribution of means of all vaccines in Public School")

# upper and lower bounds of 95% HDI
abline(v=quantile(mcmcOut[,"SchoolType-Public"], c(0.025)), col="blue")
abline(v=quantile(mcmcOut[,"SchoolType-Public"], c(0.975)), col="blue")


# numeric value of upper and lower bounds of 95% HDI
#quantile(mcmcOut[,"SchoolType-Public"],c(0.025))
#quantile(mcmcOut[,"SchoolType-Public"],c(0.975))
```


The summary below provides most crucial detail of the 95% HDI distribution

```{r}
summary(mcmcOut)
```


From the summary data and the distribution plots, there means of all vaccines for public and private schools are very different, in fact their 95% HDI distributions do not overlap at all and each is does not straddle zero, showing they are further apart from the population mean.

Overall, both frequentist ANOVA and Bayesian methods result in the same conclusion that the means of all vaccine rates between public and private schools are credibly different.


## 7. Compare medical exemptions between public and private schools. Are there any credible differences?##

### Data Prep ###

```{r}

#str(reportSample)
#str(reportSample$medical)

# are there any missing values in allVaccs?
#length(complete.cases(reportSample$medical)) # no missing values

set.seed(123) # control the randomization

# obtain 100 random public school medical rates sample means, repeat X1000
medicalRates <- replicate(1000, mean(sample(PublicSchoolGroup$medical, 100, replace = TRUE)))
SchoolType <- as.factor("Public")
publicDF <- data.frame(medicalRates,SchoolType)

# obtain 100 random private school medical rates sample means, repeat X1000
medicalRates <- replicate(1000, mean(sample(PrivateSchoolGroup$medical, 100, replace = TRUE)))
SchoolType <- as.factor("Private")
privateDF <- data.frame(medicalRates,SchoolType)

# combine both groups into single group of both public and private medical rate samples
SchoolMeds <- rbind(publicDF,privateDF)

#View(SchoolMeds)
```

**Boxplot of the distributions**

```{r}
boxplot(medicalRates ~ SchoolType, data = SchoolMeds)
```

The boxplots show that there is a difference in median rates of both Public and Private school medical exemption rates, with medical exemption lightly higher in Pravate schools.

### Frequentist Approach###


```{r}

vacOut <- aov(medicalRates ~ SchoolType, data = SchoolMeds)
summary(vacOut)


#t.test(SchoolMeds$medicalRates[SchoolMeds$SchoolType=="Public"], #SchoolMeds$medicalRates[SchoolMeds$SchoolType=="Private"])
```

There were a total of 2000 elements, 1000 each from public and private schools mean samples. The degrees of freedom residual elements are 1998 with 1 element left to vary between the two groups during the statistical calculation of ANOVA.

The Sum Sq value is 1.819 between groups and 19.481 within groups - and it shows the raw initial calculation of variability.

The Mean Sq is 1.8188 between groups and 0.0098 within groups - it is the variance (the sum of squares divided by the degress of freedom).

The F-Value of the overall test is 186.5 and it is the ratio of the mean squares between and within groups.

The Pr(>F) is <2e-16 which is the probability of a larger F-value of this ratio (186.5) within the F-distribution.

For the result to be statistically significant, the F-Value must substantially exceed 1 under the assumption that all the data was sampled from the same underlying population - as is the case here. Also, the Pr(>F) has to be less than the alpha value ( in this case, alpha is 0.05)


**In summary:**

The null hypothesis is that there is no difference in sample means of medical exemption rates between public and private schools.

The alternative hypothesis is that the sample means of medical exemption rates between public and private schools are different.

Since the Pr(>F) of <2e-16 is less than alpha-value (0.05), we reject the null hypothesis and conclude that the test is statistically significant; there is credible evidence that sample means of medicine rates between public and private schools are different.


### Bayesian Approach using Anova Bayes Factor ###

```{r}
medBayesOut <- anovaBF(medicalRates ~ SchoolType, data = SchoolMeds)
summary(medBayesOut)

```

Plot of means

```{r}
mcmcOut <- posterior(medBayesOut,iterations = 10000)
plot(mcmcOut[,"mu"])
```


**95% HDI distribution of means of all medical exemption rates in Private School**

The 95% HDI distribution does not include 0 as shown below. It deviates from the population mean slightly. The 95% HDI upper bound to lower bounds ranges from 0.02570818  to 0.03436204.

```{r}
par(mfcol=c(1,1))
hist(mcmcOut[,"SchoolType-Private"], main = "95% HDI dist: Medical Exemptions in Private School")

# upper and lower bounds of 95% HDI
abline(v=quantile(mcmcOut[,"SchoolType-Private"], c(0.025)), col="blue")
abline(v=quantile(mcmcOut[,"SchoolType-Private"], c(0.975)), col="blue")
```

**95% HDI distribution of means of all medical exemption rates in Public School**

The 95% HDI distribution does not include 0 as shown below. The 95% HDI upper bound to lower bounds ranges from -0.03436204 to -0.02570818.

```{r}
par(mfcol=c(1,1))
hist(mcmcOut[,"SchoolType-Public"], main = "95% HDI dist: Medical exemptions in Public School")

# upper and lower bounds of 95% HDI
abline(v=quantile(mcmcOut[,"SchoolType-Public"], c(0.025)), col="blue")
abline(v=quantile(mcmcOut[,"SchoolType-Public"], c(0.975)), col="blue")
```

The summary below provides most crucial detail of the 95% HDI distribution:

```{r}
summary(mcmcOut)
```

From the summary data and the distribution plots, the means of medical exemptions for public and private schools are very different, in fact their 95% HDI distributions do not overlap at all and each does not straddle zero, showing they are apart from the population mean.

Overall, both frequentist ANOVA and Bayesian methods result in the same conclusion that the means of medical exemption rates between public and private schools are credibly different.

## 8. Compare religious/belief exemptions between public and private schools. Are there any credible differences? ##

### Data Prep ###
```{r}

#str(reportSample)
str(reportSample$religious)

# are there any missing values in allVaccs?
length(complete.cases(reportSample$religious)) # no missing values

set.seed(123) # control the randomization

# obtain 100 random public school medical rates sample means, repeat X1000
religiousRates <- replicate(1000, mean(sample(PublicSchoolGroup$religious, 100, replace = TRUE)))
SchoolType <- as.factor("Public")
publicDF <- data.frame(religiousRates,SchoolType)

# obtain 100 random private school medical rates sample means, repeat X1000
religiousRates <- replicate(1000, mean(sample(PrivateSchoolGroup$religious, 100, replace = TRUE)))
SchoolType <- as.factor("Private")
privateDF <- data.frame(religiousRates,SchoolType)

# combine both groups into single group of both public and private medical rate samples
SchoolRels <- rbind(publicDF,privateDF)

#View(SchoolMeds)

```

**Boxplot of the distributions**

```{r}
boxplot(religiousRates ~ SchoolType, data = SchoolRels)
```

The box plot shows that the medians of religious rates between public school and private schools are very different; private schools have a higher median.


**Analysis of Variance between Public and Private schools Religious Rates**

```{r}
vacOut <- aov(religiousRates ~ SchoolType, data = SchoolRels)
summary(vacOut)
```

There were a total of 2000 elements, 1000 each from public and private schools. The degrees of freedom residual elements are 1998 with 1 element left to vary between the two groups during the statistical calculation of ANOVA.

The Sum Sq value is 8862 between groups and 2458 within groups - and it shows the raw initial calculation of variability.

The Mean Sq is 8862 between groups and 1 within groups - and it is the variance (the sum of squares divided by the degress of freedom).

The F-Value of the overall test is 7203 and it is the ratio of the mean squares between and within groups.

The Pr(>F) is <2e-16 - it is the probability of a larger F-value of this ratio (7203) within the F-distribution.

For the result to be statistically significant, the F-Value must substantially exceed 1 under the assumption that all the data was sampled from the same underlying population - as is the case here. Also, the Pr(>F) has to be less than the alpha value ( in this case, alpha is 0.05)

**In summary:**

The null hypothesis is that there is no difference in sample means of religious rates between public and private schools.

The alternative hypothesis is that the sample means of religious rates between public and private schools are different.

Since the Pr(>F) of <2e-16 is less than alpha-value (0.05), we reject the null hypothesis and conclude that the test is statistically significant; there is credible evidence that sample means of religious rates between public and private schools are different.

##Bayesian Approach##

**Bayes Factor Analysis**

```{r}
vacBayesOut <- anovaBF(religiousRates ~ SchoolType, data = SchoolRels)
summary(vacBayesOut)
```

**Plot of means**

```{r}
mcmcOut <- posterior(vacBayesOut,iterations = 10000)
plot(mcmcOut[,"mu"])
```

**95% HDI distribution of means of all vaccine rates in Private School**

The 95% HDI distribution does not include 0 as shown below which means it deviates from the population mean considerably. The 95% HDI upper bound to lower bounds ranges from 2.0557 to 2.153556 

```{r}
par(mfcol=c(1,1))
hist(mcmcOut[,"SchoolType-Private"], main = "95% HDI distribution of means of Religious rates in Private School")

# upper and lower bounds of 95% HDI
abline(v=quantile(mcmcOut[,"SchoolType-Private"], c(0.025)), col="blue")
abline(v=quantile(mcmcOut[,"SchoolType-Private"], c(0.975)), col="blue")
```

**95% HDI distribution of means of all vaccine rates in Public School**

The 95% HDI distribution does not include 0 as shown below which means it deviates from the population mean considerably. The 95% HDI upper bound to lower bounds ranges from -2.153556 to -2.0557.

```{r}
par(mfcol=c(1,1))
hist(mcmcOut[,"SchoolType-Public"], main = "95% HDI distribution of means of Religious Rates in Public School")

# upper and lower bounds of 95% HDI
abline(v=quantile(mcmcOut[,"SchoolType-Public"], c(0.025)), col="blue")
abline(v=quantile(mcmcOut[,"SchoolType-Public"], c(0.975)), col="blue")
```

The summary below provides most crucial detail of the 95% HDI distribution

```{r}
summary(mcmcOut)
```


From the summary data and the distribution plots, the means of religious rates for public and private schools are very different, in fact their 95% HDI distributions do not overlap at all and each is does not straddle zero, showing they are further apart from the population mean.

Overall, both frequentist ANOVA and Bayesian methods result in the same conclusion that the means of all vaccine rates between public and private schools are credibly different.



## 9. Is it possible to predict whether a school is public or private based on conditional,medical, and religious percentages? If so, what are the specifics? ##

Because the outcome to be predicted is categorical, a logistic regression approach is preferred. Outcomes from both Frequentist and Bayesian approaches are shown below.

### Frequentist Approach ###

**Building the Model and Interpreting the Model Summary**

```{r}

# make sure school type is a factor, to simplify reporting
str(reportSample$pubpriv)


chOut <- glm(formula = pubpriv ~ conditional + medical + religious, family = binomial(), data = reportSample)

summary(chOut)
```

A general linear model is used that takes conditional, medical and religious percentages as the predictor variables to predict the the school type (Private or Public) The general linear model uses the binomial family for logistic output.

The output shows that the intercept is significantly different from zero - since the intercept represents the log-odds of a "Public" outcome when all the predictor variables are equal to zero.

The coefficient of the conditional rate predictor is not statistically significant based on the Wald's z-value of -0.23 and associated p-value of 0.818. Since p = 0.818 means p > .001, we fail to reject the null hypothesis that the log-odds of conditional rates is 0 in the population.

The coefficient of the medical rate predictor is not statistically significant based on the Wald's z-value of -0.51 and associated p-value of 0.609. Since p = 0.609 means p > .001, we fail to reject the null hypothesis that the log-odds of medical rates is 0 in the population.

The coefficient of the religious rate predictor is statistically significant based on the Wald's z-value of -4.26 and associated p-value of 2.07e-05. Since p = 2.07e-05 means p < .001, we reject the null hypothesis that the log-odds of conditional rates is 0 in the population.

**Converting log odds to straight odds**

```{r}
coef(chOut)
```

The straight odds show that the intercept represent odds of 1.74:1 for a the school type being "Private" given that all the predictors are equal to zero. The odds of -0.002:1 for conditional rate show that for every conditional exemptions, the school is 0.2% less likely to be a private school. In the case of medical rates, the ods are -0.05:1, meaning that the odds of being a private school decreases with every increase in medical exemption rate by approximately 0.5%. In the case of religious rates, the ods are -0.05:1, meaning that the odds of being a private school decreases with every increase in medical exemption rate by approximately 0.5%.


**Examination of confidence intervals**
```{r}
exp(confint(chOut))
```

The 95% confidence interval for religious predictor rates ranges from a low of 0.9369964:1 to a high of 0.9758728:1. At the low end of the confidence interval, an increase in religious exemption rates by 1% corresponds to 0.9369964:1 in favor a Private school while at the high end of the confidence interval, 1% increase in religious exemptions corresponds to a 
0.9758728:1 in favor this being a private school.



**Reporting the Chi-square test:**

```{r}
anova(chOut, test = "Chisq")
```

The test contains three nested models, with the first chi-square test comparing the null model to a model with just the conditional rates, the second one contains medical and religious, and the third one contains just religious.

Only the last chi-square test is statistically significant because p = 7.636e-06 is below the threshold of p < 0.001. This results makes sense in light of the siginifance tests on the co-efficients and confirms the utility of a model that contains only religious predictor variables.


**Tabulating "Private" vs "Public" Predictions**
```{r}
table(round(predict(chOut, type = "response")), reportSample$pubpriv)
```

There were 7 cases where the observed school was Private and the dichotomized predictor value was "Private". These are the correct classification of "Private" schools. Likewise, there were 566 cases where the observed school was Public and the dichotomized predictor value was "Public".

Thus the overall accuracy of the model is (7 + 566)/698 which is 0.82 or 82% accuracy. 698 denomitaor is the total of all observations.


**Examining the Pseudo-R Value**

```{r}
library(BaylorEdPsych)
PseudoR2(chOut)
```

The Nagelkerke pseudo-R is reports the highest value indicating the proportion of varince in the outcome variable (privpub) that accounted for by the predictor variables (religious, medical, conditional). However, this value is very small which means that since only religious rates were significant in the prediction model, it accounts for a minimial proportion of that varition in the the outcome. This contrast maybe attributed to statistical power of the sample size assesed (698 observations) which created this relatively small effect vis-a-viz size.


### Bayesian Approach ###

**Data Prep**

The Bayes output requires numeric input, thus a transformation is done below:

```{r}
# adjust the outcome variable
reportSample$pubpriv <- as.numeric(reportSample$pubpriv) - 1
```


**Creating the Bayes Logit Output**

```{r}
# required library
library(MCMCpack)

bayesLogitOut <- MCMClogit(formula = pubpriv ~ conditional + medical + religious, data = reportSample)

summary(bayesLogitOut)
```

The summary outcome focuses on describing the posterior distributions of parameters representing both the intercept and th coefficients on conditional, medical and religious, calibrated as log-odds.

The point estimate of the intercept and the coefficients are very close or similar to the frequentist approach described earlier. 

A plot of the region between the 2.5% and 97.5% quantiles is the are of High Density Interval as shown in the plots below:


**Plotting the Bayes Logit Output**
```{r}
plot(bayesLogitOut)
```


The left colum of the plot gives the trace of the progress of th MCMClogit() function as it performs the Markov chain Monte Carlo analysis.

The right colulm shows the graphical representations of the likely poition of each coefficient. The true population value of each coefficient is likely to be somewhere in the middle of the distribution and less likely near the tails.

The density plots of conditional, and medical overlaps with zero, while the distribution of religious does not. This is a little unexpected considering that the frequentist approach showed religous variable to be the only significant variable in predicting the model.



**Examining Regular Odds for Conditional Percentages**
```{r}
# creat a matrix for apply()
conditionalLogOdds <- as.matrix(bayesLogitOut[,"conditional"])

# apply() runs exp() for each one
conditionalOdds <- apply(conditionalLogOdds, 1, exp)

# plot hist
hist(conditionalOdds)

# left edge of 95% HDI
abline(v=quantile(conditionalOdds, c(0.025)), col="blue")

# right edge of 95% HDI
abline(v=quantile(conditionalOdds, c(0.975)), col="blue")
```

Centered around 1.


**Examining the Log Odds for Religious Percentages**
```{r}
# creat a matrix for apply()
religiousLogOdds <- as.matrix(bayesLogitOut[,"religious"])

# apply() runs exp() for each one
religiousOdds <- apply(religiousLogOdds, 1, exp)

# plot hist
hist(religiousOdds)

# left edge of 95% HDI
abline(v=quantile(religiousOdds, c(0.025)), col="blue")

# right edge of 95% HDI
abline(v=quantile(religiousOdds, c(0.975)), col="blue")
```


Centered around 0.96.


**Examining the Log Odds for Medial Percentages**
```{r}
# creat a matrix for apply()
medicalLogOdds <- as.matrix(bayesLogitOut[,"medical"])

# apply() runs exp() for each one
medicalOdds <- apply(medicalLogOdds, 1, exp)

# plot hist
hist(medicalLogOdds)

# left edge of 95% HDI
abline(v=quantile(medicalLogOdds, c(0.025)), col="blue")

# right edge of 95% HDI
abline(v=quantile(medicalLogOdds, c(0.975)), col="blue")
```

Centered around 0.

Conclusion:


## 10. Is it possible to predict conditional percentage, based on the percentages of specific vaccines that are missing? If so, what are the specifics?##

### Frequentist Approach ###

**Build the Prediction Model and Evaluate Model Summary**

The dependent variable is the conditional percentages, with the missing vaccines as the independent variables.

```{r}
predVac <- lm(conditional ~ dptMiss + polMiss + mmrMiss + hepMiss + varMiss, data = reportSample)
summary(predVac)

```



The summary output shows the formula applied in the multivariate linear regression model. 

It then shows the residual summaries, and the intercept togethr with the B-weights (co-efficient) summaries that desrcribe the line of best fit that reduces the sum of squared errors the most. 

The intercept estimate is 0.66856 denoting the value of the predicted outcome (conditional percentages) when all the missing vaccine values are equal to zero.

The first three coefficients are very similar and are positive (0.71, 0.34, 0.39) except for the last two that are negative (-0.04, -1.11) The coefficient denote the contribution to the outcome, hence the first three missing vaccines (dptMiss, polMiss, mmrMiss) have a positive contribution to the dependent variable while hepMiss and varMiss have negative contribution to the dependent variable.

The t-values and the probabilities associated with thoese t-values test the null hypothesis that each of the co-efficients are equal to zero. In this case, we can reject the null hypothesis because of the small t-values and even smaller p-values for all the independent variables except hepMiss.

**Re-run the model after prunning**

Since hepMiss has a p-value that is not significant, p-value = 0.71799, which is higher than alpha at p < 0.05, we drop it from the equation and rerun:

```{r}
predVac <- lm(conditional ~ dptMiss + polMiss + mmrMiss + varMiss, data = reportSample)
summary(predVac)

```


Now, all p-values of the coefficients are less than alpha threshold p < 0.05.

The model summary shows the multiple R-squared value of 0.6501 which shows well over half of the variation in conditional percentages can be accounted for by the four predictor missing vaccine variables working together. 

The Null hypothesis Signifince test (F-test) is whether the R-squared value is significantly different from zero. In this case we reject the null hypothesis, because the model p-value of < 2e-16 is much less than the alpha threshold of p < 0.05. The test is statistically significant.

Thus, the prediction of conditional percentages based on missing vaccines is as follows, where the bracket denote multiplication:

### conditional = 0.65548 + 0.71917(dptMiss) + 0.33356(polMiss) + 0.39583(mmrMiss) - 1.13912(varMiss)###


**Analyzing Residuals for normality/non-normality**

The mean of the residuals from the least squares processing should always be zero.

```{r}
hist(predVac$residuals)
```

The plot shows a largely normal distribution with the mean centered around zero indicating that the underlying relationship between the independet variables and the dependent variables are linear.


**Testing for multicolinearity**

By examining the Variance Inflation Factors for the independent variables as a diagnostic for multicollinearity. Whenever two independent variables are correlated, the slope (B-Weight) that is calculated only reflects the independent influence on the dependent variable, with the correlated part invisible on the weights.


```{r}
library(car)
vif(predVac)

```

High VIF values indicate multicollinearity. All of the independent variables show a VIF value greater than 3 which are indicative of possible multicollinearity. This is best confirmed by the correlation plot below with corresponding correlation strenghths of the independent variables.


```{r}
# dataframe of missing vaccines
missingVacs <- data.frame(reportSample$dptMiss, reportSample$polMiss, reportSample$mmrMiss, reportSample$varMiss)

# label the missing vacciness
titles <- c("dptMiss", "polMiss", "mmrMiss", "varMiss")

colnames(missingVacs) <- titles

my_cor <- cor(missingVacs)



corrplot(my_cor, method = "number")
```

**Conclusion:**

As shown above, the independent variables exhibit very strong correlations with each other. This can take away from the strength of the model. The R-Squared value of  0.6501 can be improved by removing multicolinearity. 


### Bayesian Approach ####

**Build the Prediction Model and Evaluate Model Summary**


```{r}
regOutMCMC <- lmBF(conditional ~ dptMiss + polMiss + mmrMiss + varMiss, data = reportSample, posterior=TRUE, iterations = 10000)

summary(regOutMCMC)
```

The output shows the means of the respective distributions and the 95% HDIs. The mean colum are the paremeter estimates of the B-Weights of each of the predictions and they are a very close match to the frequentist calculations prior.

The 2.5% and 97.5% boundaries of 95% HDIs for the IVs are very similar exept for hepMiss - this reflects similar finding in the frequentist approach where hepMiss was dropped from the initial model.

The sig2(sigma-squared) shows the model precision for each of the iterations. The smaller sig2 is, the better the prediction.

**Converting Sigma-squared values to R-squared values**

The R-squared value of each model in the posterior distribution is equal to 1 minus the value of sig2 divided by the variance in the dependent variable.

```{r}
rsqList <- 1 - (regOutMCMC[,"sig2"] / var(reportSample$conditional))

# mean
mean(rsqList)

hist(rsqList)
# lower bound of 95% HDI

abline(v=quantile(rsqList, c(0.25)), col="blue")

# upper bound of 95% HDI
abline(v=quantile(rsqList, c(0.975)), col="blue")
```

**Conclusions**

The mean value of the distribution came to 0.65 which is exactly similar to the R-squared value obtained using the frequentist approach prior. The Bayesian model also presents a clear-eyed view of the likely range of possibilities for the predictive strength of the model. It is possible to expect an R-squared value as low as about 0.64 or as high as about 0.68, with the most likely value of R-squared in the central region of 0.65











## 11. Is it possible to predict medical percentage, based on the percentages of specific vaccines that are missing? If so, what are the specifics?##

### Frequentist Approach ###

**Build the Prediction Model and Evaluate Model Summary**

The dependent variable is the conditional percentages, with the missing vaccines as the independent variables. This model does not include interaction between terms (IVs):

```{r}
predMed <- lm(medical ~ dptMiss + polMiss + mmrMiss + hepMiss + varMiss, data = reportSample)
summary(predMed)

```



The summary output shows the formula applied in the multivariate linear regression model without interaction between terms. 

It then shows the residual summaries, and the intercept together with the B-weights (co-efficient) summaries that desrcribe the line of best fit that reduces the sum of squared errors the most. 

The intercept estimate is 0.1495463 denoting the value of the predicted outcome (medical percentages) when all the missing vaccine values are equal to zero.

The t-values and the probabilities associated with thoese t-values test the null hypothesis that each of the co-efficients are equal to zero. In this case, we can fail to reject the null hypothesis because of the large p-values for all the independent variables along with an overal model p - value of 0.06205, which is greater than the alpha (p < 0.05)

An investigation of interaction between terms may help, as shown below:

**Re-run the model with interaction between terms**

The following model attempts a regression with interaction between terms.

```{r}
predMed <- lm(medical ~ dptMiss * polMiss * mmrMiss * hepMiss * varMiss, data = reportSample)
summary(predMed)

```

In the revised model, there are interactions between terms that are significant, and an overall observed p-value that appears significant. However, further prunning to remove interactions that are not significant is required to improve the model performance.

**Additional Model Prunning**
Below is another run of the model, with only the significant interactions (p-value < 0.05)


```{r}
predMed <- lm(medical ~ polMiss:hepMiss + dptMiss:polMiss:mmrMiss + polMiss:mmrMiss:hepMiss + mmrMiss:hepMiss:varMiss + dptMiss:mmrMiss:hepMiss:varMiss, data = reportSample)
summary(predMed)

```

The resulting model still bears interactions that are not significant. Further prunning yields the outcome below:

```{r}
predMed <- lm(medical ~ polMiss:hepMiss + dptMiss:mmrMiss:hepMiss:varMiss, data = reportSample)
summary(predMed)

```

Finally, all p-values of the coefficients are less than alpha threshold p < 0.05.

The model summary shows the multiple R-squared value of 0.01028 which shows very littel of the variation in medical percentages can be accounted for by the predictor missing vaccine variables working interactively. 

The Null hypothesis Signifince test (F-test) is whether the R-squared value is significantly different from zero. In this case we reject the null hypothesis, because the model p-value of < 2e-16 is much less than the alpha threshold of p < 0.05. The test is statistically significant.

Thus, the prediction of medical percentages based on missing vaccines is as follows, where the bracket denote multiplication:

### medical = 1.752e-01 + 3.182e-04(polMiss:hepMiss) + -4.310e-08(hepMiss:dptMiss:mmrMiss:varMiss) ###


**Analyzing Residuals for normality/non-normality**

The mean of the residuals from the least squares processing should always be zero.

```{r}
plot(predMed$residuals)
```

The plot shows a largely normal distribution with the mean centered around zero indicating that the underlying relationship between the independet variables and the dependent variables are linear.

**Conclusion:**

Even the the model has a statistically significant p - value, the R-Squared value of 0.01028 (adjusted to 0.00743) means very little of the variability within the depedent variable can be explained by interactions between the independent variables. Thus, the prediction of medical percentages cannot be meaningfully done with the missing vaccine variables.


### Bayesian Approach ####

**Build the Prediction Model and Evaluate Model Summary**


```{r}
regOutMCMC <- lmBF(medical ~ polMiss:hepMiss + dptMiss:mmrMiss:hepMiss:varMiss, data = reportSample, posterior=TRUE, iterations = 10000)

summary(regOutMCMC)
```

The output shows the means of the respective distributions and the 95% HDIs. The mean column is the paremeter estimates of the B-Weights of each of the predictions and they are a very close match to the frequentist calculations prior.

The 2.5% and 97.5% boundaries of 95% HDIs for the IVs are very similar exept for hepMiss - this reflects similar finding in the frequentist approach where hepMiss was dropped from the initial model.

The sig2(sigma-squared) shows the model precision for each of the iterations. The smaller sig2 is, the better the prediction.

**Converting Sigma-squared values to R-squared values**

The R-squared value of each model in the posterior distribution is equal to 1 minus the value of sig2 divided by the variance in the dependent variable.

```{r}
rsqList <- 1 - (regOutMCMC[,"sig2"] / var(reportSample$medical))

# mean
mean(rsqList)

hist(rsqList)
# lower bound of 95% HDI

abline(v=quantile(rsqList, c(0.25)), col="blue")

# upper bound of 95% HDI
abline(v=quantile(rsqList, c(0.975)), col="blue")
```

**Conclusions**

The mean value of the distribution came to 0.007 which is exactly similar to the adjusted R-squared value obtained using the frequentist approach prior. The Bayesian model presents visual look at the likely range of possibilities for the predictive strength of the model. It is possible to expect an R-squared value as low as about -0.002 or as high as about 0.011, with the most likely value of R-squared in the central region of 0.00.

The bayesian outcome confirms the frequentist outcome that it is not possible to accurately predict medical exemption rates based on the missing vaccine varriables.








## 12. Is it possible to predict religious percentage, based on the percentages of specific vaccines that are missing? If so, what are the specifics?##

### Frequentist Approach ###

**Build the Prediction Model and Evaluate Model Summary**

The dependent variable is the religious exemption percentages, with the missing vaccines as the independent variables. 

```{r}
predRel <- lm(religious ~ dptMiss + polMiss + mmrMiss + hepMiss + varMiss, data = reportSample)
summary(predRel)

```

**Initial Prunning**

Drop polMiss and mmrMiss from the model and run:

```{r}
predRel <- lm(religious ~ dptMiss + hepMiss + varMiss, data = reportSample)
summary(predRel)

```


Finally, all p-values of the coefficients are less than alpha threshold p < 0.05.

The model summary shows the multiple R-squared value of 0.7257 which shows significant proportion of the variations in religious percentages can be accounted for by the predictor missing vaccine variables working interactively.

The Null hypothesis Signifince test (F-test) is whether the R-squared value is significantly different from zero. In this case we reject the null hypothesis, because the model p-value of < 2.2e-16 is much less than the alpha threshold of p < 0.05. The test is statistically significant.

Thus, the prediction of religious exemption percentages based on missing vaccines is as follows, where the bracket denote multiplication:

### religious = 0.29353 - 0.14685(dptMiss) - 0.28496(hepMiss) + 0.57501(varMiss)###


**Analyzing Residuals for normality/non-normality**

The mean of the residuals from the least squares processing should always be zero.

```{r}
hist(predRel$residuals)
```

The plot shows a largely normal distribution with the mean centered around zero indicating that the underlying relationship between the independet variables and the dependent variables are linear.

**Conclusion:**

Even the the model has a statistically significant p - value of < 2.2e-16, the R-Squared value of 0.7257 (adjusted to 0.7246) means significant proportion of the variability within the depedent variable can be explained by the independent variables working together. Thus, the prediction of religious exemption percentages can be meaningfully done with the missing vaccine variables as follows:

**religious = 0.29353 - 0.14685(dptMiss) - 0.28496(hepMiss) + 0.57501(varMiss)**

###Bayesian Approach###

**Build the Prediction Model and Evaluate Model Summary**

```{r}
regOutMCMC <- lmBF(religious ~ dptMiss + hepMiss + varMiss, data = reportSample, posterior=TRUE, iterations = 10000)

summary(regOutMCMC)
```


The output shows the means of the respective distributions and the 95% HDIs. The mean column is the paremeter estimates of the B-Weights of each of the predictions and they are a very close match to the frequentist calculations prior.

The 2.5% and 97.5% boundaries of 95% HDIs for the IVs are very similar exept for hepMiss - this reflects similar finding in the frequentist approach where hepMiss was dropped from the initial model.

The sig2(sigma-squared) shows the model precision for each of the iterations. The smaller sig2 is, the better the prediction.

**Converting Sigma-squared values to R-squared values**

The R-squared value of each model in the posterior distribution is equal to 1 minus the value of sig2 divided by the variance in the dependent variable.

```{r}
rsqList <- 1 - (regOutMCMC[,"sig2"] / var(reportSample$religious))

# mean
mean(rsqList)
```


```{r}
hist(rsqList)
# lower bound of 95% HDI

abline(v=quantile(rsqList, c(0.25)), col="blue")

# upper bound of 95% HDI
abline(v=quantile(rsqList, c(0.975)), col="blue")
```


**Conclusions**

The mean value of the distribution came to 0.7233177 which is very similar to the adjusted R-squared value obtained using the frequentist approach prior. The Bayesian model presents visual look at the likely range of possibilities for the predictive strength of the model. It is possible to expect an R-squared value as low as about 0.71 or as high as about 0.75, with the most likely value of R-squared in the central region of 0.72.

The Bayesian outcome confirms the frequentist outcome that it is possible to accurately predict medical exemption rates based on the missing vaccine variables with credible model.

